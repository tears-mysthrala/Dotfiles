name: Generate Documentation

on:
    # Ejecutar cada domingo a las 6 AM GMT
    schedule:
        - cron: "0 6 * * 0"

    # Permitir ejecuciÃ³n manual desde GitHub UI
    workflow_dispatch:

jobs:
    generate-documentation:
        runs-on: windows-latest

        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup PowerShell
              shell: pwsh
              run: |
                  Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
                  Write-Host "OS: $($PSVersionTable.OS)"

            - name: Check for code changes since last doc update
              id: check_changes
              shell: pwsh
              run: |
                  $lastDocUpdate = git log -1 --format=%ct -- docs/
                  $lastCodeUpdate = git log -1 --format=%ct -- "*.ps1" "*.psm1" ":!tools/generate_function_docs.ps1"

                  if ($lastDocUpdate -and $lastCodeUpdate) {
                    if ([int]$lastCodeUpdate -gt [int]$lastDocUpdate) {
                      Write-Host "Code changes detected since last documentation update"
                      "needs_update=true" >> $env:GITHUB_OUTPUT
                    } else {
                      Write-Host "Documentation is up to date"
                      "needs_update=false" >> $env:GITHUB_OUTPUT
                    }
                  } else {
                    Write-Host "First run or missing docs - generating documentation"
                    "needs_update=true" >> $env:GITHUB_OUTPUT
                  }

            - name: Generate documentation
              if: steps.check_changes.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
              shell: pwsh
              run: |
                  Write-Host "Generating documentation..."
                  & "${{ github.workspace }}\tools\generate_function_docs.ps1" -Verbose

            - name: Check for documentation changes
              if: steps.check_changes.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
              id: git_status
              shell: pwsh
              run: |
                  git add docs/
                  $changes = git diff --cached --name-only
                  if ($changes) {
                    Write-Host "Documentation changes detected:"
                    $changes | ForEach-Object { Write-Host "  - $_" }
                    "has_changes=true" >> $env:GITHUB_OUTPUT
                  } else {
                    Write-Host "No documentation changes"
                    "has_changes=false" >> $env:GITHUB_OUTPUT
                  }

            - name: Commit and push documentation
              if: steps.git_status.outputs.has_changes == 'true'
              shell: pwsh
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
                  git commit -m "docs: auto-generate documentation [$timestamp]" -m "Generated by workflow on schedule"

                  git push

            - name: Summary
              if: always()
              shell: pwsh
              run: |
                  Write-Host ""
                  Write-Host "=== Documentation Generation Summary ==="
                  Write-Host "Trigger: ${{ github.event_name }}"
                  Write-Host "Needs Update: ${{ steps.check_changes.outputs.needs_update }}"
                  Write-Host "Has Changes: ${{ steps.git_status.outputs.has_changes }}"
                  Write-Host "Status: ${{ job.status }}"
